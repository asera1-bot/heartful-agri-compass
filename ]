import os
import sys

import pandas as pd
import streamlit as st
from sqlalchemy.exc import OperationalError

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã‚’sys.pathã«è¿½åŠ 
CURRENT_DIR = os.path.dirname(os.path.abspath(__file__))
APP_DIR = os.path.dirname(CURRENT_DIR)
ROOT_DIR = os.path.dirname(APP_DIR)

if ROOT_DIR not in sys.path:
    sys.path.append(ROOT_DIR)

from core.auth import require_login
from core.db import get_engine, DB_PATH

# èªè¨¼ã‚¬ãƒ¼ãƒ‰
require_login()

st.title("Compass")
st.caption("åé‡ã®å…¨ä½“å‚¾å‘ã‚’ã–ã£ãã‚Šã¤ã‹ã‚€ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰")

engine = get_engine()

# DBã‹ã‚‰ãƒ‡ãƒ¼ã‚¿å–å¾—
with engine.connect() as conn:
    df = pd.read_sql_query(
        """
        SELECT harvest_date, company, crop, amount_kg
        FROM harvest_fact
        """,
        conn,
        parse_dates=["harvest_date"]
    )
except OperationalError as e:
    st.error(f"DBèª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: {e}")
    st.stop()

if df.empty:
    st.warning("harvest_factã«ãƒ‡ãƒ¼ã‚¿ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚CSVã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚")
    st.stop()

# æ—¥ä»˜ã‚’datetimeã«å¤‰æ›
df["harvest_date"] = pd.to_datetime(df["harvest_date"], errors="coerce")
df["amount_kg"] = pd.to_numeric(df["amount_kg"], errors="coerce")
df = df.dropna(subset=["amount_kg", "amount_kg", "company", "crop"]).copy()

# è¡¨ç¤ºãƒ»ãƒ•ã‚£ãƒ«ã‚¿ç”¨ï¼ˆæ—¥ä»˜ã ã‘ï¼‰
df["harvest_day"] = df["harvest_date"].dt.date

# ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼UI
st.markdown("### æœŸé–“ãƒ•ã‚£ãƒ«ã‚¿")

min_date = df["harvest_date"].min()
max_date = df["harvest_date"].max()

col1, col2 = st.columns(2)
with col1:
    start_date = st.date_input(
        "é–‹å§‹æ—¥",
        value=min_date,
        min_value=min_date,
        max_value=max_date,
    )

with col2:
    end_date = st.date_input(
        "çµ‚äº†æ—¥",
        value=max_date,
        min_value=min_date,
        max_value=max_date,
    )

if start_date > end_date:
    st.error("é–‹å§‹æ—¥ãŒçµ‚äº†æ—¥ã‚ˆã‚Šå¾Œã«ãªã£ã¦ã„ã¾ã™ã€‚æœŸé–“ã‚’è¦‹ç›´ã—ã¦ãã ã•ã„ã€‚")
    st.stop()

# ã¾ãšæœŸé–“ã§çµã‚‹ï¼ˆã“ã“ãŒåœŸå°ï¼‰
df_period = df[(df["harvest_day"] >= start) & (df["harvest_day"] <= end_date)].copy()

if df_period.empty:
    st.warning("ã“ã®æœŸé–“ã«ã¯ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚åˆ¥ã®æœŸé–“ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚")
    st.stop()

# ä¼æ¥­ãƒ•ã‚£ãƒ«ã‚¿/ä½œç‰©ã®é¸æŠè‚¢ã¯ã€ŒæœŸé–“å†…ã€ã«é™å®šï¼ˆï¼µï¼©ãŒè»½ããªã‚‹ï¼‰
all_companies = sorted(df["company"].unique().tolist())
all_crops = sorted(df["crop"].unique().tolist())

st.markdown("### ä¼æ¥­ãƒ»ä½œç‰©ãƒ•ã‚£ãƒ«ã‚¿")
cc1, cc2 = st.columns(2)
with cc1:
    selected_companies = st.multiselect(
        "ä¼æ¥­ï¼ˆæœªé¸æŠï¼å…¨ä»¶ï¼‰",
        options=all_companies,
        default[],
    )

with cc2:
    selected_crops = st.multiselect(
        "ä½œç‰©ï¼ˆæœªé¸æŠï¼å…¨ä»¶ï¼‰",
        options=all_crops,
        default=[],
    )

# ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨
filtered = df_period.copy()

if selected_companies:
    filtered = filtered[filtered["company"].isin(selected_companies)]
if selected_crops:
    filtered = filtered[filtered["crop"].isin(selected_crops)]

if filtered.empty:
    st.warning("é¸æŠã•ã‚ŒãŸæ¡ä»¶ã«è©²å½“ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’èª¿æ•´ã—ã¦ãã ã•ã„ã€‚")
    st.stop()

# KPIæŒ‡æ¨™ï¼ˆ3ã¤ï¼‰
st.markdown("###ã€€ğŸš€KPIæ¦‚è¦")

total_kg = float(filtered["amount_kg"].sum())
days = int(filtered["harvest_day"].nunique())
companies = int(filtered["compnay"].nunique())
crops = int(filtered["crop"].nunique())
avg_per_day = total_kg / days if days > 0 else 0.0

k1, k2, k3 = st.columns(3)
k1.metric("æœŸé–“ç´¯è¨ˆåé‡[kg]", f"{total_kg:.1f}")
k2.metric("ï¼‘æ—¥ã‚ãŸã‚Šå¹³å‡åé‡[kg/æ—¥]", f"{avg_per_day:.1f}")
k3.metric("ä¼æ¥­æ•° / ä½œç‰©æ•°", f"{companies} ç¤¾ / {crops} å“ç›®")

# ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆTop5ï¼‰
st.markdown("### ä¼æ¥­åˆ¥åé‡ãƒ©ãƒ³ã‚­ãƒ³ã‚°(Top5)")

df_company = (
    df_period
    .groupby("company", as_index=False)["amount_kg"]
    .sum()
    .sort_values("amount_kg", ascending=False)
)

st.dataframe(df_company.head(5), width="stretch")

st.markdown("### ä½œç‰©åˆ¥åé‡ãƒ©ãƒ³ã‚­ãƒ³ã‚°")

df_crop = (
    df_period
    .groupby("crop", as_index=False)["amount_kg"]
    .sum()
    .sort_values("amount_kg", ascending=False)
)

st.dataframe(df_crop.head(5), width="stretch")

st.markdown("----")

# æ—¥åˆ¥ãƒ»ä¼æ¥­åˆ¥åˆè¨ˆã‚°ãƒ©ãƒ•
daily = (
    filtered.groupby("harvest_date", as_index=False)["amount_kg"]
    .sum()
    .sort_values("harvest_date")
)
st.subheader("æ—¥åˆ¥åé‡ã®æ¨ç§»")
st.line_chart(daily, x="harvest_date", y="amount_kg")

company = (
    filtered.groupby("company", as_index=False)["amount_kg"]
    .sum()
    .sort_values("amount_kg", ascending=False)
)
st.subheader("ä¼æ¥­åˆ¥åé‡ï¼ˆåˆè¨ˆï¼‰")
st.bar_chart(company, x="company", y="amount_kg")

st.markdown("----")

# ç”Ÿãƒ‡ãƒ¼ã‚¿
st.subheader("ç”Ÿãƒ‡ãƒ¼ã‚¿(harvest_fact")
st.dataframe(
    filtered.sort_values(["harvest_date", "company", "crop"]),
    width="stretch",
)
